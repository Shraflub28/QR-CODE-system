<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Restaurant</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-header { background: white; box-shadow: var(--shadow); padding: 1.5rem 0; margin-bottom: 2rem; }
        .admin-nav { display: flex; gap: 1rem; margin-top: 1rem; border-bottom: 2px solid var(--border-color); }
        .nav-tab { padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: all 0.2s ease; }
        .nav-tab:hover { color: var(--text-primary); }
        .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .qr-code-img { max-width: 200px; margin: 1rem auto; display: block; }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="pageTitle">Admin Panel</h1>
                <div class="language-selector">
                    <button class="language-btn" data-lang="en">EN</button>
                    <button class="language-btn" data-lang="fr">FR</button>
                    <button class="language-btn" data-lang="ar">AR</button>
                </div>
            </div>
            <div class="admin-nav">
                <button class="nav-tab active" data-tab="tables" id="tabTables">Tables</button>
                <button class="nav-tab" data-tab="categories" id="tabCategories">Categories</button>
                <button class="nav-tab" data-tab="menu" id="tabMenu">Menu Items</button>
                <button class="nav-tab" data-tab="orders" id="tabOrders">Orders</button>
                <button class="nav-tab" data-tab="employees" id="tabEmployees">Employees</button>
                <button class="nav-tab" data-tab="analytics" id="tabAnalytics">Analytics</button>
                <button class="nav-tab" data-tab="ai-assistant" id="tabAI">AI Assistant</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="tab-content active" id="tablesContent">
            <div class="action-bar">
                <h2 id="tablesTitle">Tables</h2>
                <button class="btn btn-primary" id="addTableBtn">+ Add Table</button>
            </div>
            <div class="table-container">
                <table class="table" id="tablesTable">
                    <thead><tr><th>Table #</th><th>Status</th><th>QR Code</th><th>Actions</th></tr></thead>
                    <tbody id="tablesBody"><tr><td colspan="4"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="categoriesContent">
            <div class="action-bar">
                <h2>Categories</h2>
                <button class="btn btn-primary" id="addCategoryBtn">+ Add Category</button>
            </div>
            <div class="table-container">
                <table class="table" id="categoriesTable">
                    <thead><tr><th>Slug</th><th>Display Order</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="categoriesBody"><tr><td colspan="4"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="menuContent">
            <div class="action-bar">
                <h2 id="menuTitle">Menu Items</h2>
                <button class="btn btn-primary" id="addMenuBtn">+ Add Item</button>
            </div>
            <div class="table-container">
                <table class="table" id="menuTable">
                    <thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Available</th><th>Actions</th></tr></thead>
                    <tbody id="menuBody"><tr><td colspan="5"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="ordersContent">
            <h2 id="ordersTitle">Recent Orders</h2>
            <div class="table-container">
                <table class="table" id="ordersTable">
                    <thead><tr><th>Order #</th><th>Table</th><th>Items</th><th>Total</th><th>Status</th><th>Time</th></tr></thead>
                    <tbody id="ordersBody"><tr><td colspan="6"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="employeesContent">
            <div class="action-bar">
                <h2>Employees</h2>
                <button class="btn btn-primary" id="addEmployeeBtn">+ Add Employee</button>
            </div>
            <div class="table-container">
                <table class="table" id="employeesTable">
                    <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="employeesBody"><tr><td colspan="6"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="analyticsContent">
            <h2>Analytics & Work History</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <div>
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-input" id="analyticsStartDate">
                </div>
                <div>
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-input" id="analyticsEndDate">
                </div>
            </div>
            <button class="btn btn-primary" id="loadAnalyticsBtn" style="margin-bottom: 1.5rem;">Load Analytics</button>
            
            <div id="analyticsResults">
                <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
        </div>
        
        <div class="tab-content" id="ai-assistantContent">
            <h2>ğŸ¤– AI Restaurant Assistant</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Ask me anything about your restaurant's performance, employees, orders, or revenue!</p>
            
            <div id="chatContainer" style="background: white; border-radius: 8px; box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1rem; height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;">
                <div class="chat-message assistant-message" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; max-width: 80%;">
                    <strong>AI Assistant:</strong>
                    <p style="margin: 0.5rem 0 0 0;">Hello! I'm your restaurant AI assistant. I can help you analyze your business data. Try asking me:</p>
                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                        <li>"How much revenue did I make in April?"</li>
                        <li>"Who is the most active employee?"</li>
                        <li>"What were my total orders last month?"</li>
                        <li>"Show me employee work hours this week"</li>
                    </ul>
                </div>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" class="form-input" id="aiChatInput" placeholder="Ask me about your restaurant..." style="flex: 1;">
                <button class="btn btn-primary" id="sendChatBtn">Send</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="tableModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="tableModalTitle">Add Table</h3><button class="btn btn-sm" id="closeTableModal">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Table Number</label><input type="number" class="form-input" id="tableNumber" required></div>
                <div id="qrCodePreview"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelTable">Cancel</button><button class="btn btn-primary" id="saveTable">Save</button></div>
        </div>
    </div>
    
    <div class="modal" id="menuModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="menuModalTitle">Add Menu Item</h3><button class="btn btn-sm" id="closeMenuModal">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="itemName" required></div>
                <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="itemDescription"></textarea></div>
                <div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="itemPrice" step="0.01" required></div>
                <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="itemCategory"><option value="appetizers">Appetizers</option><option value="mains">Main Courses</option><option value="desserts">Desserts</option><option value="drinks">Drinks</option></select></div>
                <div class="form-group"><label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" class="form-checkbox" id="itemAvailable" checked> Available</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelMenu">Cancel</button><button class="btn btn-primary" id="saveMenu">Save</button></div>
        </div>
    </div>
    
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="categoryModalTitle">Add Category</h3><button class="btn btn-sm" id="closeCategoryModal">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Slug (lowercase, no spaces)</label><input type="text" class="form-input" id="categorySlug" placeholder="e.g., appetizers" required></div>
                <div class="form-group"><label class="form-label">Display Order</label><input type="number" class="form-input" id="categoryOrder" value="0" required></div>
                <div class="form-group"><label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" class="form-checkbox" id="categoryActive" checked> Active</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelCategory">Cancel</button><button class="btn btn-primary" id="saveCategory">Save</button></div>
        </div>
    </div>
    
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="employeeModalTitle">Add Employee</h3><button class="btn btn-sm" id="closeEmployeeModal">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="employeeName" required></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="employeeEmail" required></div>
                <div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="employeePhone"></div>
                <div class="form-group"><label class="form-label">Role</label><input type="text" class="form-input" id="employeeRole" placeholder="e.g., Staff, Kitchen, Manager, Admin" required></div>
                <div class="form-group"><label class="form-label">Password (leave empty to keep current)</label><input type="password" class="form-input" id="employeePassword"></div>
                <div class="form-group"><label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" class="form-checkbox" id="employeeActive" checked> Active</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelEmployee">Cancel</button><button class="btn btn-primary" id="saveEmployee">Save</button></div>
        </div>
    </div>
    
    <script type="module">
        import { supabaseClient } from '/assets/js/supabase-client.js';
        import { loadLanguage, getBrowserLanguage, setPageDirection, getUrlParameter, setUrlParameter, formatCurrency, formatDateTime, generateQRCodeUrl, showSuccess, showError } from '/assets/js/utils.js';
        
        let currentLang = getUrlParameter('lang') || getBrowserLanguage();
        let translations = {};
        let currentTab = 'tables';
        let editingId = null;
        
        async function init() {
            try {
                translations = await loadLanguage(currentLang);
                setPageDirection(currentLang);
                updateLanguageButtons();
                updateUIText();
                await supabaseClient.init();
                await loadTabData();
                setupEventListeners();
            } catch (error) {
                console.error('Init error:', error);
                showError('body', translations.errors?.loadFailed || 'Failed to load');
            }
        }
        
        async function loadTabData() {
            if (currentTab === 'tables') await loadTables();
            else if (currentTab === 'categories') await loadCategories();
            else if (currentTab === 'menu') await loadMenu();
            else if (currentTab === 'orders') await loadOrders();
            else if (currentTab === 'employees') await loadEmployees();
            else if (currentTab === 'analytics') await initAnalytics();
            else if (currentTab === 'ai-assistant') await initAIAssistant();
        }
        
        async function loadTables() {
            try {
                const tables = await supabaseClient.getTables();
                const tbody = document.getElementById('tablesBody');
                if (tables.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No tables found</td></tr>';
                    return;
                }
                tbody.innerHTML = tables.map(t => `
                    <tr>
                        <td>${t.table_number}</td>
                        <td>${t.active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">Inactive</span>'}</td>
                        <td><a href="${generateQRCodeUrl(t.id, currentLang)}" target="_blank">View QR</a></td>
                        <td><button class="btn btn-sm btn-danger" onclick="window.deleteTable('${t.id}')">Delete</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load tables error:', error);
            }
        }
        
        async function loadCategories() {
            try {
                const categories = await supabaseClient.getCategories();
                const tbody = document.getElementById('categoriesBody');
                if (categories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No categories found</td></tr>';
                    return;
                }
                tbody.innerHTML = categories.map(c => `
                    <tr>
                        <td>${c.slug}</td>
                        <td>${c.display_order}</td>
                        <td><span class="badge badge-${c.active ? 'success' : 'danger'}">${c.active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="window.editCategory('${c.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteCategory('${c.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load categories error:', error);
            }
        }
        
        async function loadMenu() {
            try {
                const items = await supabaseClient.getMenuItems();
                const tbody = document.getElementById('menuBody');
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No items found</td></tr>';
                    return;
                }
                tbody.innerHTML = items.map(i => `
                    <tr>
                        <td>${i.name}</td>
                        <td>${i.categories?.slug || 'N/A'}</td>
                        <td>${formatCurrency(i.price)}</td>
                        <td><span class="badge badge-${i.available ? 'success' : 'danger'}">${i.available ? 'Yes' : 'No'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="window.editMenuItem('${i.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteMenuItem('${i.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load menu error:', error);
            }
        }
        
        async function loadOrders() {
            try {
                const orders = await supabaseClient.getOrders({});
                const tbody = document.getElementById('ordersBody');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No orders found</td></tr>';
                    return;
                }
                tbody.innerHTML = orders.slice(0, 20).map(o => `
                    <tr>
                        <td>#${o.id.slice(0, 8)}</td>
                        <td>${o.tables?.table_number || 'N/A'}</td>
                        <td>${(o.items || []).length} items</td>
                        <td>${formatCurrency(o.total)}</td>
                        <td><span class="badge badge-info">${o.status}</span></td>
                        <td>${formatDateTime(o.created_at)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load orders error:', error);
            }
        }
        
        window.deleteTable = async function(id) {
            if (!confirm('Delete this table?')) return;
            try {
                await supabaseClient.deleteTable(id);
                showSuccess('Table deleted');
                await loadTables();
            } catch (error) {
                showError(null, 'Failed to delete');
            }
        };
        
        window.editMenuItem = async function(id) {
            try {
                const items = await supabaseClient.getMenuItems();
                const item = items.find(i => i.id === id);
                if (!item) return;
                
                editingId = id;
                document.getElementById('menuModalTitle').textContent = 'Edit Menu Item';
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('itemCategory').value = item.categories?.slug || 'appetizers';
                document.getElementById('itemAvailable').checked = item.available;
                document.getElementById('menuModal').classList.add('show');
            } catch (error) {
                showError(null, 'Failed to load item');
            }
        };
        
        window.deleteMenuItem = async function(id) {
            if (!confirm('Delete this item?')) return;
            try {
                await supabaseClient.deleteMenuItem(id);
                showSuccess('Item deleted');
                await loadMenu();
            } catch (error) {
                showError(null, 'Failed to delete');
            }
        };
        
        window.editCategory = async function(id) {
            try {
                const categories = await supabaseClient.getCategories();
                const category = categories.find(c => c.id === id);
                if (!category) return;
                
                editingId = id;
                document.getElementById('categoryModalTitle').textContent = 'Edit Category';
                document.getElementById('categorySlug').value = category.slug;
                document.getElementById('categoryOrder').value = category.display_order;
                document.getElementById('categoryActive').checked = category.active;
                document.getElementById('categoryModal').classList.add('show');
            } catch (error) {
                showError(null, 'Failed to load category');
            }
        };
        
        window.deleteCategory = async function(id) {
            if (!confirm('Delete this category? Menu items using this category will have no category.')) return;
            try {
                await supabaseClient.deleteCategory(id);
                showSuccess('Category deleted');
                await loadCategories();
            } catch (error) {
                showError(null, 'Failed to delete');
            }
        };
        
        async function loadEmployees() {
            try {
                const employees = await supabaseClient.getEmployees();
                const tbody = document.getElementById('employeesBody');
                if (employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No employees found</td></tr>';
                    return;
                }
                tbody.innerHTML = employees.map(e => `
                    <tr>
                        <td>${e.name}</td>
                        <td>${e.email}</td>
                        <td><span class="badge badge-info">${e.role}</span></td>
                        <td>${e.phone || 'N/A'}</td>
                        <td><span class="badge badge-${e.active ? 'success' : 'danger'}">${e.active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="window.editEmployee('${e.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteEmployee('${e.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load employees error:', error);
            }
        }
        
        window.editEmployee = async function(id) {
            try {
                const employees = await supabaseClient.getEmployees();
                const employee = employees.find(e => e.id === id);
                if (!employee) return;
                
                editingId = id;
                document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
                document.getElementById('employeeName').value = employee.name;
                document.getElementById('employeeEmail').value = employee.email;
                document.getElementById('employeePhone').value = employee.phone || '';
                document.getElementById('employeeRole').value = employee.role;
                document.getElementById('employeePassword').value = '';
                document.getElementById('employeeActive').checked = employee.active;
                document.getElementById('employeeModal').classList.add('show');
            } catch (error) {
                showError(null, 'Failed to load employee');
            }
        };
        
        window.deleteEmployee = async function(id) {
            if (!confirm('Delete this employee?')) return;
            try {
                await supabaseClient.deleteEmployee(id);
                showSuccess('Employee deleted');
                await loadEmployees();
            } catch (error) {
                showError(null, 'Failed to delete');
            }
        };
        
        async function initAnalytics() {
            // Set default date range (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('analyticsStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('analyticsEndDate').value = endDate.toISOString().split('T')[0];
            
            await loadAnalytics();
        }
        
        // AI Assistant Configuration
        const AI_API_URL = 'https://text.pollinations.ai/openai';
        const AI_TOKEN = 'abcok6DiII4AOrN6';
        
        async function initAIAssistant() {
            // Just initialize, chat container already has welcome message
        }
        
        async function getRestaurantContext() {
            try {
                // Gather all restaurant data for AI context
                const [orders, employees, analytics, shifts] = await Promise.all([
                    supabaseClient.getOrders({}),
                    supabaseClient.getEmployees(),
                    supabaseClient.getDailyAnalytics({ 
                        startDate: new Date(new Date().setMonth(new Date().getMonth() - 6)).toISOString().split('T')[0],
                        endDate: new Date().toISOString().split('T')[0]
                    }),
                    supabaseClient.getEmployeeShifts({
                        startDate: new Date(new Date().setMonth(new Date().getMonth() - 3)).toISOString().split('T')[0],
                        endDate: new Date().toISOString().split('T')[0]
                    })
                ]);
                
                // Calculate key metrics
                const totalRevenue = analytics.reduce((sum, a) => sum + parseFloat(a.total_revenue || 0), 0);
                const totalOrders = orders.length;
                
                // Employee activity
                const employeeActivity = {};
                shifts.forEach(shift => {
                    const empId = shift.employee_id;
                    if (!employeeActivity[empId]) {
                        employeeActivity[empId] = {
                            name: shift.employees?.name || 'Unknown',
                            totalHours: 0,
                            shiftCount: 0
                        };
                    }
                    employeeActivity[empId].totalHours += parseFloat(shift.hours_worked || 0);
                    employeeActivity[empId].shiftCount += 1;
                });
                
                // Monthly revenue breakdown
                const monthlyRevenue = {};
                analytics.forEach(a => {
                    const date = new Date(a.business_date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyRevenue[monthKey]) {
                        monthlyRevenue[monthKey] = 0;
                    }
                    monthlyRevenue[monthKey] += parseFloat(a.total_revenue || 0);
                });
                
                return {
                    totalRevenue,
                    totalOrders,
                    averageOrderValue: totalOrders > 0 ? totalRevenue / totalOrders : 0,
                    employeeCount: employees.length,
                    employees: employees.map(e => ({ name: e.name, role: e.role, active: e.active })),
                    employeeActivity: Object.values(employeeActivity),
                    monthlyRevenue,
                    recentAnalytics: analytics.slice(0, 30),
                    currentDate: new Date().toISOString().split('T')[0]
                };
            } catch (error) {
                console.error('Error gathering context:', error);
                return null;
            }
        }
        
        // Function to execute queries based on AI needs
        async function executeQuery(queryType, params = {}) {
            try {
                switch(queryType) {
                    case 'orders':
                        return await supabaseClient.getOrders(params);
                    case 'employees':
                        return await supabaseClient.getEmployees();
                    case 'analytics':
                        return await supabaseClient.getDailyAnalytics(params);
                    case 'shifts':
                        return await supabaseClient.getEmployeeShifts(params);
                    case 'menu':
                        return await supabaseClient.getMenuItems();
                    case 'tables':
                        return await supabaseClient.getTables();
                    default:
                        return null;
                }
            } catch (error) {
                console.error('Query error:', error);
                return null;
            }
        }
        
        async function sendMessageToAI(userMessage) {
            try {
                console.log('ğŸ¤– AI Assistant: Processing question:', userMessage);
                console.log('ğŸ“Š Fetching real-time data from Supabase...');
                
                // Always fetch fresh data from Supabase
                console.time('â±ï¸ Data fetch time');
                const [orders, employees, analytics, shifts, menu, tables] = await Promise.all([
                    supabaseClient.getOrders({}),
                    supabaseClient.getEmployees(),
                    supabaseClient.getDailyAnalytics({ 
                        startDate: new Date(new Date().setFullYear(new Date().getFullYear() - 1)).toISOString().split('T')[0],
                        endDate: new Date().toISOString().split('T')[0]
                    }),
                    supabaseClient.getEmployeeShifts({
                        startDate: new Date(new Date().setFullYear(new Date().getFullYear() - 1)).toISOString().split('T')[0],
                        endDate: new Date().toISOString().split('T')[0]
                    }),
                    supabaseClient.getMenuItems(),
                    supabaseClient.getTables()
                ]);
                console.timeEnd('â±ï¸ Data fetch time');
                
                console.log('âœ… Data fetched successfully:');
                console.log('  ğŸ“¦ Orders:', orders.length, 'total');
                console.log('  ğŸ‘¥ Employees:', employees.length, 'total');
                console.log('  ğŸ“ˆ Analytics records:', analytics.length, 'days');
                console.log('  â° Shifts:', shifts.length, 'total');
                console.log('  ğŸ½ï¸ Menu items:', menu.length, 'total');
                console.log('  ğŸª‘ Tables:', tables.length, 'total');
                
                // Calculate useful metrics
                const totalRevenue = analytics.reduce((sum, a) => sum + parseFloat(a.total_revenue || 0), 0);
                const totalOrders = orders.length;
                
                console.log('ğŸ’° Calculated metrics:');
                console.log('  Total Revenue:', `$${totalRevenue.toFixed(2)}`);
                console.log('  Total Orders:', totalOrders);
                console.log('  Avg Order Value:', `$${(totalOrders > 0 ? totalRevenue / totalOrders : 0).toFixed(2)}`);
                
                // Employee activity
                const employeeActivity = {};
                shifts.forEach(shift => {
                    const empId = shift.employee_id;
                    const empName = shift.employees?.name || 'Unknown';
                    if (!employeeActivity[empId]) {
                        employeeActivity[empId] = {
                            name: empName,
                            role: shift.employees?.role || 'Unknown',
                            totalHours: 0,
                            shiftCount: 0
                        };
                    }
                    employeeActivity[empId].totalHours += parseFloat(shift.hours_worked || 0);
                    employeeActivity[empId].shiftCount += 1;
                });
                
                console.log('ğŸ‘¥ Employee Activity:');
                Object.values(employeeActivity).forEach(emp => {
                    console.log(`  ${emp.name} (${emp.role}): ${emp.shiftCount} shifts, ${emp.totalHours.toFixed(1)}h`);
                });
                
                // Monthly revenue
                const monthlyRevenue = {};
                analytics.forEach(a => {
                    const date = new Date(a.business_date);
                    const monthKey = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                    if (!monthlyRevenue[monthKey]) {
                        monthlyRevenue[monthKey] = 0;
                    }
                    monthlyRevenue[monthKey] += parseFloat(a.total_revenue || 0);
                });
                
                console.log('ğŸ“… Monthly Revenue:');
                Object.entries(monthlyRevenue).forEach(([month, revenue]) => {
                    console.log(`  ${month}: $${revenue.toFixed(2)}`);
                });
                
                // Build employee list
                const employeeList = employees.map(e => `- ${e.name} (${e.role}) - ${e.active ? 'Active' : 'Inactive'}`).join('\n');
                const employeeActivityList = Object.values(employeeActivity).length > 0 
                    ? Object.values(employeeActivity).map(emp => `- ${emp.name} (${emp.role}): ${emp.shiftCount} shifts, ${emp.totalHours.toFixed(1)} hours total`).join('\n')
                    : 'No shift data available';
                const monthlyRevenueList = Object.keys(monthlyRevenue).length > 0
                    ? Object.entries(monthlyRevenue).map(([month, revenue]) => `- ${month}: ${revenue.toFixed(2)} MAD`).join('\n')
                    : 'No revenue data available';
                const analyticsData = analytics.length > 0
                    ? analytics.slice(0, 30).map(a => `- ${a.business_date}: Revenue ${parseFloat(a.total_revenue || 0).toFixed(2)} MAD, Orders: ${a.total_orders || 0}`).join('\n')
                    : 'No analytics data available';
                
                // Build comprehensive prompt with ALL data
                const fullPrompt = `You are a helpful AI assistant for a restaurant management system in Morocco. You MUST answer the user's question using ONLY the REAL DATA provided below. DO NOT give generic responses.

USER QUESTION: ${userMessage}

IMPORTANT: The user is asking about THEIR restaurant data. Use the numbers and information below to answer.

RESTAURANT DATA (Real-time from database):

EMPLOYEES (${employees.length} total):
${employeeList}

EMPLOYEE ACTIVITY (Work Hours):
${employeeActivityList}

MONTHLY REVENUE:
${monthlyRevenueList}

SUMMARY STATISTICS:
- Total Revenue (all time): ${totalRevenue.toFixed(2)} MAD
- Total Orders: ${totalOrders}
- Average Order Value: ${(totalOrders > 0 ? totalRevenue / totalOrders : 0).toFixed(2)} MAD
- Active Employees: ${employees.filter(e => e.active).length}
- Total Menu Items: ${menu.length}
- Total Tables: ${tables.length}

RECENT DAILY ANALYTICS (Last 30 days):
${analyticsData}

INSTRUCTIONS: 
1. Answer the user's question DIRECTLY using the data above
2. Include specific numbers from the data
3. If they ask "how many employees", count from the EMPLOYEES list above
4. DO NOT say "What's on your mind" or ask clarifying questions
5. Give a direct, data-driven answer
6. ALWAYS use "MAD" (Moroccan Dirham) for currency, NEVER use "$" or "dollars"
7. This is a Moroccan restaurant, so use MAD for all prices and revenue

Answer:`;

                console.log('ğŸ“ Prompt created (length:', fullPrompt.length, 'chars)');
                console.log('ğŸ“¤ FULL PROMPT BEING SENT:');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log(fullPrompt);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ğŸ”— Sending request to AI API...');
                
                // Use proper OpenAI-compatible format
                const payload = {
                    model: "openai-large",
                    messages: [
                        {
                            role: "user",
                            content: fullPrompt
                        }
                    ],
                    stream: false,
                    referrer: "https://g4f.dev/",
                    seed: "10352102"
                };
                
                console.log('ğŸ“¦ Payload:', JSON.stringify(payload, null, 2));
                
                console.time('â±ï¸ AI response time');
                const response = await fetch(`${AI_API_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                console.timeEnd('â±ï¸ AI response time');
                
                if (!response.ok) {
                    console.error('âŒ API Error:', response.status, response.statusText);
                    throw new Error(`AI API request failed: ${response.status}`);
                }
                
                console.log('âœ… AI API responded successfully');
                const data = await response.text();
                console.log('ğŸ“¥ Raw response length:', data.length, 'chars');
                console.log('ğŸ“¥ Raw response:', data.substring(0, 200) + '...');
                
                // Parse JSON response and extract message content
                try {
                    const jsonData = JSON.parse(data);
                    console.log('âœ… Response is valid JSON');
                    console.log('ğŸ“Š JSON structure:', Object.keys(jsonData));
                    
                    if (jsonData.choices && jsonData.choices[0] && jsonData.choices[0].message) {
                        const aiMessage = jsonData.choices[0].message.content;
                        console.log('âœ… Extracted AI message (preview):', aiMessage.substring(0, 100) + '...');
                        console.log('ğŸ’¬ FULL AI RESPONSE:');
                        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        console.log(aiMessage);
                        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        return aiMessage || "I couldn't generate a response. Please try again.";
                    }
                } catch (parseError) {
                    console.log('âš ï¸ Response is not JSON, returning as text');
                    console.log('ğŸ’¬ FULL TEXT RESPONSE:');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log(data);
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                }
                
                return data || "I couldn't generate a response. Please try again.";
                
            } catch (error) {
                console.error('AI Error:', error);
                return "I'm having trouble connecting to the AI service. Please check your connection and try again.";
            }
        }
        
        function addChatMessage(message, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user-message' : 'assistant-message'}`;
            messageDiv.style.cssText = `
                background: ${isUser ? 'var(--primary-color)' : 'var(--bg-secondary)'};
                color: ${isUser ? 'white' : 'var(--text-primary)'};
                padding: 1rem;
                border-radius: 8px;
                max-width: 80%;
                ${isUser ? 'margin-left: auto;' : ''}
            `;
            
            messageDiv.innerHTML = `
                <strong>${isUser ? 'You' : 'AI Assistant'}:</strong>
                <p style="margin: 0.5rem 0 0 0; white-space: pre-wrap;">${message}</p>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        async function handleSendMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, true);
            input.value = '';
            
            // Add loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading';
            loadingDiv.style.cssText = 'background: var(--bg-secondary); padding: 1rem; border-radius: 8px; max-width: 80%;';
            loadingDiv.innerHTML = '<strong>AI Assistant:</strong><p style="margin: 0.5rem 0 0 0;">Thinking...</p>';
            document.getElementById('chatContainer').appendChild(loadingDiv);
            
            // Get AI response
            const response = await sendMessageToAI(message);
            
            // Remove loading
            document.getElementById('ai-loading')?.remove();
            
            // Add AI response
            addChatMessage(response, false);
        }
        
        async function loadAnalytics() {
            try {
                const startDate = document.getElementById('analyticsStartDate').value;
                const endDate = document.getElementById('analyticsEndDate').value;
                
                if (!startDate || !endDate) {
                    showError(null, 'Please select date range');
                    return;
                }
                
                const resultsDiv = document.getElementById('analyticsResults');
                resultsDiv.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
                
                // Get analytics data
                const analytics = await supabaseClient.getDailyAnalytics({ startDate, endDate });
                const shifts = await supabaseClient.getEmployeeShifts({ startDate, endDate });
                
                // Calculate totals
                const totalRevenue = analytics.reduce((sum, a) => sum + parseFloat(a.total_revenue || 0), 0);
                const totalOrders = analytics.reduce((sum, a) => sum + parseInt(a.total_orders || 0), 0);
                const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                
                // Build HTML
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.875rem;">Total Revenue</h3>
                            <p style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--primary-color);">${formatCurrency(totalRevenue)}</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.875rem;">Total Orders</h3>
                            <p style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--success-color);">${totalOrders}</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.875rem;">Avg Order Value</h3>
                            <p style="margin: 0; font-size: 2rem; font-weight: bold; color: var(--info-color);">${formatCurrency(avgOrderValue)}</p>
                        </div>
                    </div>
                    
                    <h3 style="margin: 2rem 0 1rem 0;">Daily Breakdown</h3>
                `;
                
                // Group shifts by date
                const shiftsByDate = {};
                shifts.forEach(shift => {
                    if (!shiftsByDate[shift.shift_date]) {
                        shiftsByDate[shift.shift_date] = [];
                    }
                    shiftsByDate[shift.shift_date].push(shift);
                });
                
                // Create analytics by date
                const analyticsByDate = {};
                analytics.forEach(a => {
                    analyticsByDate[a.business_date] = a;
                });
                
                // Generate date range
                const dates = [];
                const current = new Date(startDate);
                const end = new Date(endDate);
                while (current <= end) {
                    dates.push(current.toISOString().split('T')[0]);
                    current.setDate(current.getDate() + 1);
                }
                
                // Display each day
                dates.reverse().forEach(date => {
                    const dayAnalytics = analyticsByDate[date];
                    const dayShifts = shiftsByDate[date] || [];
                    
                    html += `
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0;">${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>
                                <div style="display: flex; gap: 1rem;">
                                    <span style="font-weight: bold; color: var(--primary-color);">Revenue: ${formatCurrency(dayAnalytics?.total_revenue || 0)}</span>
                                    <span style="font-weight: bold; color: var(--success-color);">Orders: ${dayAnalytics?.total_orders || 0}</span>
                                </div>
                            </div>
                            
                            <div>
                                <h5 style="margin: 0.5rem 0; color: var(--text-secondary);">Employees Working:</h5>
                                ${dayShifts.length > 0 ? `
                                    <div style="display: grid; gap: 0.5rem;">
                                        ${dayShifts.map(shift => {
                                            const startTime = new Date(shift.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                            const endTime = shift.end_time ? new Date(shift.end_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : 'Still working';
                                            const hours = shift.hours_worked ? shift.hours_worked.toFixed(2) : 'N/A';
                                            return `
                                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px; display: flex; justify-content: space-between;">
                                                    <span><strong>${shift.employees?.name}</strong> (${shift.employees?.role})</span>
                                                    <span>${startTime} - ${endTime} (${hours}h)</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p style="color: var(--text-secondary); margin: 0;">No employees worked this day</p>'}
                            </div>
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Load analytics error:', error);
                document.getElementById('analyticsResults').innerHTML = '<p style="color: red;">Failed to load analytics</p>';
            }
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(currentTab + 'Content').classList.add('active');
                    loadTabData();
                });
            });
            
            document.getElementById('addTableBtn').addEventListener('click', () => {
                editingId = null;
                document.getElementById('tableModal').classList.add('show');
            });
            
            document.getElementById('addMenuBtn').addEventListener('click', () => {
                editingId = null;
                document.getElementById('menuModalTitle').textContent = 'Add Menu Item';
                document.getElementById('itemName').value = '';
                document.getElementById('itemDescription').value = '';
                document.getElementById('itemPrice').value = '';
                document.getElementById('itemCategory').value = 'appetizers';
                document.getElementById('itemAvailable').checked = true;
                document.getElementById('menuModal').classList.add('show');
            });
            
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                editingId = null;
                document.getElementById('categoryModalTitle').textContent = 'Add Category';
                document.getElementById('categorySlug').value = '';
                document.getElementById('categoryOrder').value = '0';
                document.getElementById('categoryActive').checked = true;
                document.getElementById('categoryModal').classList.add('show');
            });
            
            document.getElementById('addEmployeeBtn').addEventListener('click', () => {
                editingId = null;
                document.getElementById('employeeModalTitle').textContent = 'Add Employee';
                document.getElementById('employeeName').value = '';
                document.getElementById('employeeEmail').value = '';
                document.getElementById('employeePhone').value = '';
                document.getElementById('employeeRole').value = '';
                document.getElementById('employeePassword').value = '';
                document.getElementById('employeeActive').checked = true;
                document.getElementById('employeeModal').classList.add('show');
            });
            
            document.getElementById('loadAnalyticsBtn').addEventListener('click', loadAnalytics);
            
            // AI Assistant event listeners
            document.getElementById('sendChatBtn').addEventListener('click', handleSendMessage);
            document.getElementById('aiChatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });
            
            document.getElementById('closeTableModal').addEventListener('click', () => {
                document.getElementById('tableModal').classList.remove('show');
            });
            
            document.getElementById('closeMenuModal').addEventListener('click', () => {
                document.getElementById('menuModal').classList.remove('show');
            });
            
            document.getElementById('closeCategoryModal').addEventListener('click', () => {
                document.getElementById('categoryModal').classList.remove('show');
            });
            
            document.getElementById('closeEmployeeModal').addEventListener('click', () => {
                document.getElementById('employeeModal').classList.remove('show');
            });
            
            document.getElementById('cancelTable').addEventListener('click', () => {
                document.getElementById('tableModal').classList.remove('show');
            });
            
            document.getElementById('cancelMenu').addEventListener('click', () => {
                document.getElementById('menuModal').classList.remove('show');
            });
            
            document.getElementById('cancelCategory').addEventListener('click', () => {
                document.getElementById('categoryModal').classList.remove('show');
            });
            
            document.getElementById('cancelEmployee').addEventListener('click', () => {
                document.getElementById('employeeModal').classList.remove('show');
            });
            
            document.getElementById('saveTable').addEventListener('click', async () => {
                const tableData = {
                    table_number: parseInt(document.getElementById('tableNumber').value)
                };
                try {
                    await supabaseClient.createTable(tableData);
                    showSuccess('Table created');
                    document.getElementById('tableModal').classList.remove('show');
                    await loadTables();
                } catch (error) {
                    showError(null, 'Failed to save');
                }
            });
            
            document.getElementById('saveMenu').addEventListener('click', async () => {
                // Get category ID from slug
                const categories = await supabaseClient.getCategories();
                const categorySlug = document.getElementById('itemCategory').value;
                const category = categories.find(c => c.slug === categorySlug);
                
                const itemData = {
                    name: document.getElementById('itemName').value,
                    description: document.getElementById('itemDescription').value,
                    price: parseFloat(document.getElementById('itemPrice').value),
                    category_id: category?.id,
                    available: document.getElementById('itemAvailable').checked
                };
                
                try {
                    if (editingId) {
                        await supabaseClient.updateMenuItem(editingId, itemData);
                        showSuccess('Item updated');
                    } else {
                        await supabaseClient.createMenuItem(itemData);
                        showSuccess('Item created');
                    }
                    document.getElementById('menuModal').classList.remove('show');
                    await loadMenu();
                    editingId = null;
                } catch (error) {
                    showError(null, 'Failed to save');
                }
            });
            
            document.getElementById('saveCategory').addEventListener('click', async () => {
                const categoryData = {
                    slug: document.getElementById('categorySlug').value.toLowerCase().replace(/\s+/g, '_'),
                    display_order: parseInt(document.getElementById('categoryOrder').value),
                    active: document.getElementById('categoryActive').checked
                };
                
                try {
                    if (editingId) {
                        await supabaseClient.updateCategory(editingId, categoryData);
                        showSuccess('Category updated');
                    } else {
                        await supabaseClient.createCategory(categoryData);
                        showSuccess('Category created');
                    }
                    document.getElementById('categoryModal').classList.remove('show');
                    await loadCategories();
                    editingId = null;
                } catch (error) {
                    showError(null, 'Failed to save category');
                }
            });
            
            document.getElementById('saveEmployee').addEventListener('click', async () => {
                const employeeData = {
                    name: document.getElementById('employeeName').value,
                    email: document.getElementById('employeeEmail').value,
                    phone: document.getElementById('employeePhone').value,
                    role: document.getElementById('employeeRole').value,
                    active: document.getElementById('employeeActive').checked
                };
                
                const password = document.getElementById('employeePassword').value;
                if (password) {
                    // For simplicity, using a dummy hash. In production, hash on backend
                    employeeData.password_hash = '$2a$10$dummy_hash_' + password;
                }
                
                try {
                    if (editingId) {
                        await supabaseClient.updateEmployee(editingId, employeeData);
                        showSuccess('Employee updated');
                    } else {
                        if (!password) {
                            showError(null, 'Password is required for new employees');
                            return;
                        }
                        await supabaseClient.createEmployee(employeeData);
                        showSuccess('Employee created');
                    }
                    document.getElementById('employeeModal').classList.remove('show');
                    await loadEmployees();
                    editingId = null;
                } catch (error) {
                    showError(null, 'Failed to save employee');
                }
            });
            
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentLang = btn.dataset.lang;
                    setUrlParameter('lang', currentLang);
                    location.reload();
                });
            });
        }
        
        function updateLanguageButtons() {
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
        }
        
        function updateUIText() {
            document.getElementById('pageTitle').textContent = translations.admin?.title || 'Admin Panel';
            document.getElementById('tabTables').textContent = translations.admin?.tables || 'Tables';
            document.getElementById('tabMenu').textContent = translations.admin?.menu || 'Menu Items';
            document.getElementById('tabOrders').textContent = translations.admin?.orders || 'Orders';
            document.title = translations.admin?.title || 'Admin Panel';
        }
        
        init();
    </script>
</body>
</html>
