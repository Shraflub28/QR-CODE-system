<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Restaurant</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-header { background: white; box-shadow: var(--shadow); padding: 1.5rem 0; margin-bottom: 2rem; }
        .admin-nav { display: flex; gap: 1rem; margin-top: 1rem; border-bottom: 2px solid var(--border-color); }
        .nav-tab { padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: all 0.2s ease; }
        .nav-tab:hover { color: var(--text-primary); }
        .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .qr-code-img { max-width: 200px; margin: 1rem auto; display: block; }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="pageTitle">Admin Panel</h1>
                <div class="language-selector">
                    <button class="language-btn" data-lang="en">EN</button>
                    <button class="language-btn" data-lang="fr">FR</button>
                    <button class="language-btn" data-lang="ar">AR</button>
                </div>
            </div>
            <div class="admin-nav">
                <button class="nav-tab active" data-tab="tables" id="tabTables">Tables</button>
                <button class="nav-tab" data-tab="categories" id="tabCategories">Categories</button>
                <button class="nav-tab" data-tab="menu" id="tabMenu">Menu Items</button>
                <button class="nav-tab" data-tab="orders" id="tabOrders">Orders</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="tab-content active" id="tablesContent">
            <div class="action-bar">
                <h2 id="tablesTitle">Tables</h2>
                <button class="btn btn-primary" id="addTableBtn">+ Add Table</button>
            </div>
            <div class="table-container">
                <table class="table" id="tablesTable">
                    <thead><tr><th>Table #</th><th>Status</th><th>QR Code</th><th>Actions</th></tr></thead>
                    <tbody id="tablesBody"><tr><td colspan="4"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="categoriesContent">
            <div class="action-bar">
                <h2>Categories</h2>
                <button class="btn btn-primary" id="addCategoryBtn">+ Add Category</button>
            </div>
            <div class="table-container">
                <table class="table" id="categoriesTable">
                    <thead><tr><th>Slug</th><th>Display Order</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="categoriesBody"><tr><td colspan="4"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="menuContent">
            <div class="action-bar">
                <h2 id="menuTitle">Menu Items</h2>
                <button class="btn btn-primary" id="addMenuBtn">+ Add Item</button>
            </div>
            <div class="table-container">
                <table class="table" id="menuTable">
                    <thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Available</th><th>Actions</th></tr></thead>
                    <tbody id="menuBody"><tr><td colspan="5"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="ordersContent">
            <h2 id="ordersTitle">Recent Orders</h2>
            <div class="table-container">
                <table class="table" id="ordersTable">
                    <thead><tr><th>Order #</th><th>Table</th><th>Items</th><th>Total</th><th>Status</th><th>Time</th></tr></thead>
                    <tbody id="ordersBody"><tr><td colspan="6"><div class="loading-spinner"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal" id="tableModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="tableModalTitle">Add Table</h3><button class="btn btn-sm" id="closeTableModal">×</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Table Number</label><input type="number" class="form-input" id="tableNumber" required></div>
                <div id="qrCodePreview"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelTable">Cancel</button><button class="btn btn-primary" id="saveTable">Save</button></div>
        </div>
    </div>
    
    <div class="modal" id="menuModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="menuModalTitle">Add Menu Item</h3><button class="btn btn-sm" id="closeMenuModal">×</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="itemName" required></div>
                <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="itemDescription"></textarea></div>
                <div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="itemPrice" step="0.01" required></div>
                <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="itemCategory"><option value="appetizers">Appetizers</option><option value="mains">Main Courses</option><option value="desserts">Desserts</option><option value="drinks">Drinks</option></select></div>
                <div class="form-group"><label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" class="form-checkbox" id="itemAvailable" checked> Available</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelMenu">Cancel</button><button class="btn btn-primary" id="saveMenu">Save</button></div>
        </div>
    </div>
    
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="categoryModalTitle">Add Category</h3><button class="btn btn-sm" id="closeCategoryModal">×</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Slug (lowercase, no spaces)</label><input type="text" class="form-input" id="categorySlug" placeholder="e.g., appetizers" required></div>
                <div class="form-group"><label class="form-label">Display Order</label><input type="number" class="form-input" id="categoryOrder" value="0" required></div>
                <div class="form-group"><label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" class="form-checkbox" id="categoryActive" checked> Active</label></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelCategory">Cancel</button><button class="btn btn-primary" id="saveCategory">Save</button></div>
        </div>
    </div>
    
    <script type="module">
        import { supabaseClient } from '/assets/js/supabase-client.js';
        import { loadLanguage, getBrowserLanguage, setPageDirection, getUrlParameter, setUrlParameter, formatCurrency, formatDateTime, generateQRCodeUrl, showSuccess, showError } from '/assets/js/utils.js';
        
        let currentLang = getUrlParameter('lang') || getBrowserLanguage();
        let translations = {};
        let currentTab = 'tables';
        let editingId = null;
        
        async function init() {
            try {
                translations = await loadLanguage(currentLang);
                setPageDirection(currentLang);
                updateLanguageButtons();
                updateUIText();
                await supabaseClient.init();
                await loadTabData();
                setupEventListeners();
            } catch (error) {
                console.error('Init error:', error);
                showError('body', translations.errors?.loadFailed || 'Failed to load');
            }
        }
        
        async function loadTabData() {
            if (currentTab === 'tables') await loadTables();
            else if (currentTab === 'categories') await loadCategories();
            else if (currentTab === 'menu') await loadMenu();
            else if (currentTab === 'orders') await loadOrders();
        }
        
        async function loadTables() {
            try {
                const tables = await supabaseClient.getTables();
                const tbody = document.getElementById('tablesBody');
                if (tables.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No tables found</td></tr>';
                    return;
                }
                tbody.innerHTML = tables.map(t => `
                    <tr>
                        <td>${t.table_number}</td>
                        <td>${t.active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">Inactive</span>'}</td>
                        <td><a href="${generateQRCodeUrl(t.id, currentLang)}" target="_blank">View QR</a></td>
                        <td><button class="btn btn-sm btn-danger" onclick="window.deleteTable('${t.id}')">Delete</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load tables error:', error);
            }
        }
        
        async function loadCategories() {
            try {
                const categories = await supabaseClient.getCategories();
                const tbody = document.getElementById('categoriesBody');
                if (categories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No categories found</td></tr>';
                    return;
                }
                tbody.innerHTML = categories.map(c => `
                    <tr>
                        <td>${c.slug}</td>
                        <td>${c.display_order}</td>
                        <td><span class="badge badge-${c.active ? 'success' : 'danger'}">${c.active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="window.editCategory('${c.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteCategory('${c.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load categories error:', error);
            }
        }
        
        async function loadMenu() {
            try {
                const items = await supabaseClient.getMenuItems();
                const tbody = document.getElementById('menuBody');
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No items found</td></tr>';
                    return;
                }
                tbody.innerHTML = items.map(i => `
                    <tr>
                        <td>${i.name}</td>
                        <td>${i.categories?.slug || 'N/A'}</td>
                        <td>${formatCurrency(i.price)}</td>
                        <td><span class="badge badge-${i.available ? 'success' : 'danger'}">${i.available ? 'Yes' : 'No'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="window.editMenuItem('${i.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteMenuItem('${i.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load menu error:', error);
            }
        }
        
        async function loadOrders() {
            try {
                const orders = await supabaseClient.getOrders({});
                const tbody = document.getElementById('ordersBody');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No orders found</td></tr>';
                    return;
                }
                tbody.innerHTML = orders.slice(0, 20).map(o => `
                    <tr>
                        <td>#${o.id.slice(0, 8)}</td>
                        <td>${o.tables?.table_number || 'N/A'}</td>
                        <td>${(o.items || []).length} items</td>
                        <td>${formatCurrency(o.total)}</td>
                        <td><span class="badge badge-info">${o.status}</span></td>
                        <td>${formatDateTime(o.created_at)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load orders error:', error);
            }
        }
        
        window.deleteTable = async function(id) {
            if (!confirm('Delete this table?')) return;
            try {
                await supabaseClient.deleteTable(id);
                showSuccess('Table deleted');
                await loadTables();
            } catch (error) {
                showError(null, 'Failed to delete');
            }
        };
        
        window.editMenuItem = async function(id) {
            try {
                const items = await supabaseClient.getMenuItems();
                const item = items.find(i => i.id === id);
                if (!item) return;
                
                editingId = id;
                document.getElementById('menuModalTitle').textContent = 'Edit Menu Item';
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('itemCategory').value = item.categories?.slug || 'appetizers';
                document.getElementById('itemAvailable').checked = item.available;
                document.getElementById('menuModal').classList.add('show');
            } catch (error) {
                showError(null, 'Failed to load item');
            }
        };
        
        window.deleteMenuItem = async function(id) {
            if (!confirm('Delete this item?')) return;
            try {
                await supabaseClient.deleteMenuItem(id);
                showSuccess('Item deleted');
                await loadMenu();
            } catch (error) {
                showError(null, 'Failed to delete');
            }
        };
        
        window.editCategory = async function(id) {
            try {
                const categories = await supabaseClient.getCategories();
                const category = categories.find(c => c.id === id);
                if (!category) return;
                
                editingId = id;
                document.getElementById('categoryModalTitle').textContent = 'Edit Category';
                document.getElementById('categorySlug').value = category.slug;
                document.getElementById('categoryOrder').value = category.display_order;
                document.getElementById('categoryActive').checked = category.active;
                document.getElementById('categoryModal').classList.add('show');
            } catch (error) {
                showError(null, 'Failed to load category');
            }
        };
        
        window.deleteCategory = async function(id) {
            if (!confirm('Delete this category? Menu items using this category will have no category.')) return;
            try {
                await supabaseClient.deleteCategory(id);
                showSuccess('Category deleted');
                await loadCategories();
            } catch (error) {
                showError(null, 'Failed to delete');
            }
        };
        
        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(currentTab + 'Content').classList.add('active');
                    loadTabData();
                });
            });
            
            document.getElementById('addTableBtn').addEventListener('click', () => {
                editingId = null;
                document.getElementById('tableModal').classList.add('show');
            });
            
            document.getElementById('addMenuBtn').addEventListener('click', () => {
                editingId = null;
                document.getElementById('menuModalTitle').textContent = 'Add Menu Item';
                document.getElementById('itemName').value = '';
                document.getElementById('itemDescription').value = '';
                document.getElementById('itemPrice').value = '';
                document.getElementById('itemCategory').value = 'appetizers';
                document.getElementById('itemAvailable').checked = true;
                document.getElementById('menuModal').classList.add('show');
            });
            
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                editingId = null;
                document.getElementById('categoryModalTitle').textContent = 'Add Category';
                document.getElementById('categorySlug').value = '';
                document.getElementById('categoryOrder').value = '0';
                document.getElementById('categoryActive').checked = true;
                document.getElementById('categoryModal').classList.add('show');
            });
            
            document.getElementById('closeTableModal').addEventListener('click', () => {
                document.getElementById('tableModal').classList.remove('show');
            });
            
            document.getElementById('closeMenuModal').addEventListener('click', () => {
                document.getElementById('menuModal').classList.remove('show');
            });
            
            document.getElementById('closeCategoryModal').addEventListener('click', () => {
                document.getElementById('categoryModal').classList.remove('show');
            });
            
            document.getElementById('cancelTable').addEventListener('click', () => {
                document.getElementById('tableModal').classList.remove('show');
            });
            
            document.getElementById('cancelMenu').addEventListener('click', () => {
                document.getElementById('menuModal').classList.remove('show');
            });
            
            document.getElementById('cancelCategory').addEventListener('click', () => {
                document.getElementById('categoryModal').classList.remove('show');
            });
            
            document.getElementById('saveTable').addEventListener('click', async () => {
                const tableData = {
                    table_number: parseInt(document.getElementById('tableNumber').value)
                };
                try {
                    await supabaseClient.createTable(tableData);
                    showSuccess('Table created');
                    document.getElementById('tableModal').classList.remove('show');
                    await loadTables();
                } catch (error) {
                    showError(null, 'Failed to save');
                }
            });
            
            document.getElementById('saveMenu').addEventListener('click', async () => {
                // Get category ID from slug
                const categories = await supabaseClient.getCategories();
                const categorySlug = document.getElementById('itemCategory').value;
                const category = categories.find(c => c.slug === categorySlug);
                
                const itemData = {
                    name: document.getElementById('itemName').value,
                    description: document.getElementById('itemDescription').value,
                    price: parseFloat(document.getElementById('itemPrice').value),
                    category_id: category?.id,
                    available: document.getElementById('itemAvailable').checked
                };
                
                try {
                    if (editingId) {
                        await supabaseClient.updateMenuItem(editingId, itemData);
                        showSuccess('Item updated');
                    } else {
                        await supabaseClient.createMenuItem(itemData);
                        showSuccess('Item created');
                    }
                    document.getElementById('menuModal').classList.remove('show');
                    await loadMenu();
                    editingId = null;
                } catch (error) {
                    showError(null, 'Failed to save');
                }
            });
            
            document.getElementById('saveCategory').addEventListener('click', async () => {
                const categoryData = {
                    slug: document.getElementById('categorySlug').value.toLowerCase().replace(/\s+/g, '_'),
                    display_order: parseInt(document.getElementById('categoryOrder').value),
                    active: document.getElementById('categoryActive').checked
                };
                
                try {
                    if (editingId) {
                        await supabaseClient.updateCategory(editingId, categoryData);
                        showSuccess('Category updated');
                    } else {
                        await supabaseClient.createCategory(categoryData);
                        showSuccess('Category created');
                    }
                    document.getElementById('categoryModal').classList.remove('show');
                    await loadCategories();
                    editingId = null;
                } catch (error) {
                    showError(null, 'Failed to save category');
                }
            });
            
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentLang = btn.dataset.lang;
                    setUrlParameter('lang', currentLang);
                    location.reload();
                });
            });
        }
        
        function updateLanguageButtons() {
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
        }
        
        function updateUIText() {
            document.getElementById('pageTitle').textContent = translations.admin?.title || 'Admin Panel';
            document.getElementById('tabTables').textContent = translations.admin?.tables || 'Tables';
            document.getElementById('tabMenu').textContent = translations.admin?.menu || 'Menu Items';
            document.getElementById('tabOrders').textContent = translations.admin?.orders || 'Orders';
            document.title = translations.admin?.title || 'Admin Panel';
        }
        
        init();
    </script>
</body>
</html>
